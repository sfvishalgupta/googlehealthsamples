<%@ Page Language="C#" AutoEventWireup="true" %><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><%@ Import Namespace="System.Net" %><%@ Import Namespace="System.Text.RegularExpressions" %><%@ Import Namespace="System.IO" %><%@ Import Namespace="System.Xml" %><%@ Import Namespace="Google.GData.Client" %><%@ Import Namespace="Google.GData.Health" %><%@ Import Namespace="Google.GData.Extensions" %><script runat="server">    void PrintProfile() {        GAuthSubRequestFactory authFactory = new GAuthSubRequestFactory("weaver", "exampleCo-exampleApp-1");        authFactory.Token = (String) Session["token"];        HealthService service = new HealthService(authFactory.ApplicationName);        service.RequestFactory = authFactory;                HealthQuery profileQuery = new HealthQuery("https://www.google.com/h9/feeds/profile/default");        profileQuery.Digest = true;        try        {                   HealthFeed feed = service.Query(profileQuery);                        foreach (HealthEntry entry in feed.Entries )            {                XmlNode ccr = entry.CCR;                if (ccr != null)                {                    Response.Write("<pre>");                    StringWriter sw = new StringWriter();                    XmlTextWriter xw = new XmlTextWriter(sw);                    xw.Formatting = Formatting.Indented;                    ccr.WriteTo(xw);                    Response.Write(HttpUtility.HtmlEncode(sw.ToString()));                    Response.Write("</pre>");                }            }        }        catch (GDataRequestException gdre)        {            HttpWebResponse response = (HttpWebResponse)gdre.Response;                        //bad auth token, clear session and refresh the page            if (response.StatusCode == HttpStatusCode.Unauthorized)            {                Session.Clear();                Response.Redirect(Request.Url.AbsolutePath, true);            }            else            {                Response.Write("Error processing request: " + gdre.ToString());            }        }    }</script><html xmlns="http://www.w3.org/1999/xhtml" ><head runat="server">    <title>Test Site</title></head><body>    <form id="form1" runat="server">    <h1>Google Health AuthSub Profile Sample</h1>    <div>    <%        GotoAuthSubLink.Visible = false;                if (Session["token"] != null)        {            PrintProfile();        }        else if (Request.QueryString["token"] != null)        {            String token = Request.QueryString["token"];            Session["token"] = AuthSubUtil.exchangeForSessionToken(token, null).ToString();            Response.Redirect(Request.Url.AbsolutePath, true);        }        else //no auth data, print link        {            GotoAuthSubLink.Text = "Login to your Google Account";            GotoAuthSubLink.Visible = true;            String authSubLink = AuthSubUtil.getRequestUrl("http", "www.google.com",                "/h9/authsub", Request.Url.ToString(), "https://www.google.com/h9/feeds/", false, true);            authSubLink += "&permission=1";            GotoAuthSubLink.NavigateUrl = authSubLink;        }             %>    <asp:HyperLink ID="GotoAuthSubLink" runat="server"/>    </div>    </form></body></html>